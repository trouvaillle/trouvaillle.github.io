---
permalink: /app/knights-journey/script.js
---
class KnightJourney3D {
    constructor() {
        this.scene = new THREE.Scene();
        this.camera = new THREE.PerspectiveCamera(75, window.innerWidth / window.innerHeight, 0.1, 1000);
        this.renderer = new THREE.WebGLRenderer({ antialias: true });
        this.boardSize = 5;
        this.knight = null;
        this.currentPosition = null;
        this.moves = 0;
        this.visited = new Set();
        this.possibleMoves = [];
        this.controls = null;
        this.raycaster = new THREE.Raycaster();
        this.mouse = new THREE.Vector2();
        this.squares = [];
        this.possibleMoveIndicators = [];
        this.visitedSquares = [];
        this.gameStarted = false;
        this.selectingStartPosition = true;
        this.isMoving = false;
        this.isDarkTheme = window.matchMedia('(prefers-color-scheme: dark)').matches;
        this.confetti = null;
        this.gameOverOverlay = null;
        this.gameOverAnimationTimeline = null;
        
        // Î°úÏª¨ Ïä§ÌÜ†Î¶¨ÏßÄÏóêÏÑú ÌÖåÎßà ÏÑ§Ï†ï Î∂àÎü¨Ïò§Í∏∞
        const savedTheme = localStorage.getItem('theme');
        if (savedTheme) {
            this.isDarkTheme = savedTheme === 'dark';
        }
        
        this.init();
    }

    init() {
        // Renderer ÏÑ§Ï†ï
        const container = document.getElementById('board-container');
        container.style.width = '100%';
        container.style.height = '100%';
        container.style.overflow = 'hidden';
        
        const width = container.clientWidth;
        const height = container.clientHeight;
        this.renderer.setSize(width, height);
        this.renderer.setClearColor(this.isDarkTheme ? 0x1a1a1a : 0xf0f0f0);
        this.renderer.shadowMap.enabled = true;
        
        // Canvas Î™®ÏÑúÎ¶¨ Îë•Í∏ÄÍ≤å ÏÑ§Ï†ï
        this.renderer.domElement.style.borderRadius = '20px';
        this.renderer.domElement.style.overflow = 'hidden';
        
        container.appendChild(this.renderer.domElement);

        // Î™®Î∞îÏùº ÌôòÍ≤Ω Í∞êÏßÄ
        const isMobile = /iPhone|iPad|iPod|Android/i.test(navigator.userAgent);
        
        // Ïπ¥Î©îÎùº ÏÑ§Ï†ï ÏàòÏ†ï
        this.camera.aspect = width / height;
        this.camera.updateProjectionMatrix();

        // OrbitControls ÏÑ§Ï†ï - Î™®Î∞îÏùº ÌôòÍ≤Ω Í≥†Î†§
        this.controls = new THREE.OrbitControls(this.camera, this.renderer.domElement);
        this.controls.enableDamping = true;
        this.controls.dampingFactor = 0.05;
        this.controls.maxPolarAngle = Math.PI / 2;
        this.controls.enableZoom = true;
        this.controls.enablePan = false;
        this.controls.rotateSpeed = isMobile ? 0.5 : 1;

        // Ïπ¥Î©îÎùº ÏúÑÏπò Ï¥àÍ∏∞Ìôî (controls ÏÉùÏÑ± Ïù¥ÌõÑÏóê Ìò∏Ï∂ú)
        this.initializeCameraPosition();

        // Ï°∞Î™Ö ÏÑ§Ï†ï
        const ambientLight = new THREE.AmbientLight(0xffffff, 0.5);
        this.scene.add(ambientLight);

        const directionalLight = new THREE.DirectionalLight(0xffffff, 0.8);
        directionalLight.position.set(5, 5, 5);
        directionalLight.castShadow = true;
        this.scene.add(directionalLight);

        // UI ÏöîÏÜå Ïä§ÌÉÄÏùº ÏÑ§Ï†ï
        this.setupMobileFriendlyUI();

        // Î≥¥Îìú ÌÅ¨Í∏∞ ÏÑ†ÌÉù UI Ï∂îÍ∞Ä
        this.createBoardSizeSelector();
        
        // Ï≤¥Ïä§Î≥¥Îìú ÏÉùÏÑ±
        this.createBoard();
        
        // ÎÇòÏù¥Ìä∏ Î™®Îç∏ Î°úÎìú
        this.loadKnightModel();

        // Ïù¥Î≤§Ìä∏ Î¶¨Ïä§ÎÑà ÏÑ§Ï†ï
        this.setupEventListeners();
        
        // Ïï†ÎãàÎ©îÏù¥ÏÖò ÏãúÏûë
        this.animate();

        // confetti.js Ï¥àÍ∏∞Ìôî
        try {
            this.confetti = window.confetti;
            console.log('Confetti initialized successfully');
        } catch (error) {
            console.error('Failed to initialize confetti:', error);
        }
    }

    createThemeButton() {
        const container = document.createElement('div');
        container.style.position = 'absolute';
        container.style.top = '10px';
        container.style.left = '120px';
        container.style.zIndex = '1000';
        container.style.backgroundColor = 'rgba(0, 0, 0, 0.7)';
        container.style.padding = '10px';
        container.style.borderRadius = '5px';
        container.style.cursor = 'pointer';

        const button = document.createElement('button');
        button.textContent = this.isDarkTheme ? '‚òÄÔ∏è' : 'üåô';
        button.style.background = 'none';
        button.style.border = 'none';
        button.style.fontSize = '20px';
        button.style.cursor = 'pointer';
        button.style.padding = '5px';

        button.addEventListener('click', () => {
            this.isDarkTheme = !this.isDarkTheme;
            button.textContent = this.isDarkTheme ? '‚òÄÔ∏è' : 'üåô';
            this.renderer.setClearColor(this.isDarkTheme ? 0x1a1a1a : 0xf0f0f0);
            localStorage.setItem('theme', this.isDarkTheme ? 'dark' : 'light');
            this.updateBoardColors();
        });

        container.appendChild(button);
        document.getElementById('board-container').appendChild(container);
    }

    updateBoardColors() {
        // Ï≤¥Ïä§Ìåê ÏÉâÏÉÅ ÏóÖÎç∞Ïù¥Ìä∏
        this.squares.forEach((square, index) => {
            const i = Math.floor(index / this.boardSize);
            const j = index % this.boardSize;
            const isEven = (i + j) % 2 === 0;
            
            if (this.isDarkTheme) {
                square.material.color.setHex(isEven ? 0xE8E8E8 : 0xC0C0C0);
            } else {
                square.material.color.setHex(isEven ? 0xF5F5F5 : 0xD3D3D3);
            }
        });
    }

    createBoardSizeSelector() {
        const container = document.createElement('div');
        container.style.position = 'absolute';
        container.style.top = '10px';
        container.style.left = '10px';
        container.style.zIndex = '1000';
        container.style.backgroundColor = 'rgba(0, 0, 0, 0.7)';
        container.style.padding = '10px';
        container.style.borderRadius = '5px';
        container.style.color = 'white';
        container.style.display = 'flex';
        container.style.alignItems = 'center';
        container.style.gap = '8px';
        container.style.fontSize = '14px';

        const label = document.createElement('label');
        label.textContent = 'Board Size: ';
        label.style.marginRight = '5px';
        container.appendChild(label);

        const select = document.createElement('select');
        select.style.padding = '8px';
        select.style.borderRadius = '4px';
        select.style.backgroundColor = '#333';
        select.style.color = 'white';
        select.style.border = '1px solid #666';
        select.style.fontSize = '14px';
        select.style.minWidth = '80px';
        select.style.cursor = 'pointer';

        for (let size = 5; size <= 8; size++) {
            const option = document.createElement('option');
            option.value = size;
            option.textContent = `${size}x${size}`;
            if (size === this.boardSize) {
                option.selected = true;
            }
            select.appendChild(option);
        }

        select.addEventListener('change', (e) => {
            this.boardSize = parseInt(e.target.value);
            this.reset();
            this.createBoard();
            
            // Ïπ¥Î©îÎùº ÏúÑÏπò Ï¥àÍ∏∞Ìôî
            this.initializeCameraPosition();
            
            document.getElementById('moves-count').textContent = `0 / ${this.boardSize * this.boardSize}`;
        });

        container.appendChild(select);
        document.getElementById('board-container').appendChild(container);
    }

    createBoard() {
        // Í∏∞Ï°¥ Î≥¥Îìú Ï†úÍ±∞
        this.squares.forEach(square => this.scene.remove(square));
        this.squares = [];

        // Í∏∞Ï°¥ Î∞∞Í≤Ω Ìåê Ï†úÍ±∞
        const existingBoard = this.scene.children.find(child => 
            child.geometry && 
            child.geometry.type === 'BoxGeometry' && 
            child.material.color.getHex() === 0x909090
        );
        if (existingBoard) {
            this.scene.remove(existingBoard);
        }

        // Î∞∞Í≤Ω ÌÅêÎ∏å ÌÅ¨Í∏∞ Í≥ÑÏÇ∞
        const boardGeometry = new THREE.BoxGeometry(this.boardSize, 0.2, this.boardSize);
        const boardMaterial = new THREE.MeshPhongMaterial({ 
            color: 0x909090,
            specular: 0x111111,
            shininess: 30
        });
        const board = new THREE.Mesh(boardGeometry, boardMaterial);
        board.receiveShadow = true;
        board.position.y = 0;
        this.scene.add(board);

        // Ï≤¥Ïä§Ìåê Ìå®ÌÑ¥ ÏÉùÏÑ±
        const halfSize = this.boardSize / 2;
        for (let i = -halfSize; i < halfSize; i++) {
            for (let j = -halfSize; j < halfSize; j++) {
                const squareGeometry = new THREE.BoxGeometry(1, 0.1, 1);
                const squareMaterial = new THREE.MeshPhongMaterial({ 
                    color: (i + j) % 2 === 0 ? 0xE8E8E8 : 0xC0C0C0,
                    specular: 0x111111,
                    shininess: 30
                });
                const square = new THREE.Mesh(squareGeometry, squareMaterial);
                square.position.set(i + 0.5, 0.1, j + 0.5);
                square.receiveShadow = true;
                square.userData = {
                    row: i + halfSize,
                    col: j + halfSize,
                    isPossibleMove: false
                };
                this.squares.push(square);
                this.scene.add(square);
            }
        }

        // moves-count Ï¥àÍ∏∞Ìôî
        document.getElementById('moves-count').textContent = `0 / ${this.boardSize * this.boardSize}`;
    }

    createPossibleMoveIndicator() {
        const geometry = new THREE.CylinderGeometry(0.4, 0.4, 0.05, 32);
        const material = new THREE.MeshPhongMaterial({
            color: 0x4CAF50,
            transparent: true,
            opacity: 0.5,
            side: THREE.DoubleSide // ÏñëÎ©¥ Î†åÎçîÎßÅ Ï∂îÍ∞Ä
        });
        const indicator = new THREE.Mesh(geometry, material);
        indicator.userData.isPossibleMove = true; // ÏÇ¨Ïö©Ïûê Îç∞Ïù¥ÌÑ∞ Ï∂îÍ∞Ä
        return indicator;
    }

    updatePossibleMoveIndicators() {
        // Í∏∞Ï°¥ ÌëúÏãúÍ∏∞ Ï†úÍ±∞
        this.possibleMoveIndicators.forEach(indicator => {
            this.scene.remove(indicator);
        });
        this.possibleMoveIndicators = [];

        // ÏÉàÎ°úÏö¥ Í∞ÄÎä•Ìïú Ïù¥Îèô ÏúÑÏπò ÌëúÏãú
        const halfSize = this.boardSize / 2;
        this.possibleMoves.forEach(move => {
            const indicator = this.createPossibleMoveIndicator();
            indicator.position.set(-halfSize + 0.5 + move.x, 0.15, -halfSize + 0.5 + move.y);
            this.possibleMoveIndicators.push(indicator);
            this.scene.add(indicator);
        });
    }

    loadKnightModel() {
        // ColladaLoaderÍ∞Ä ÏóÜÏùÑ Í≤ΩÏö∞ Í∏∞Î≥∏ ÎÇòÏù¥Ìä∏ Î™®Îç∏ ÏÉùÏÑ±
        if (typeof THREE.ColladaLoader === 'undefined') {
            console.warn('ColladaLoader not found, using default knight model');
            this.createDefaultKnight();
            return;
        }
        
        // model reference: https://3dwarehouse.sketchup.com/model/225e2fa57e583bb82f38c0d2792fb5e/Chess-knight
        const loader = new THREE.ColladaLoader();
        loader.load(
            'knights-journey/model.dae',
            (collada) => {
                this.knight = collada.scene;
                // Î™®Îç∏ ÌÅ¨Í∏∞Î•º Ï≤¥Ïä§Ìåê cell ÏÇ¨Ïù¥Ï¶àÏóê ÎßûÍ≤å ÎåÄÌè≠ Ï∂ïÏÜå
                this.knight.scale.set(0.025, 0.025, 0.025);
                this.knight.position.set(-3.5, 0.3, -3.5);
                this.knight.visible = false;

                // ÏÉàÎ°úÏö¥ material ÏÉùÏÑ±
                const knightMaterial = new THREE.MeshPhongMaterial({
                    color: 0xC0C0C0,
                    flatShading: false,
                    wireframe: false,
                    side: THREE.FrontSide,
                    shininess: 100,
                    specular: 0x111111
                });

                this.knight.traverse((node) => {
                    // lines Ï†úÍ±∞
                    if (node.type === 'Line' || node.type === 'LineSegments') {
                        this.knight.remove(node);
                        return;
                    }

                    if (node.isMesh) {
                        // Í∏∞Ï°¥ material Ï†úÍ±∞
                        if (node.material) {
                            if (Array.isArray(node.material)) {
                                node.material.forEach(mat => {
                                    if (mat.dispose) mat.dispose();
                                });
                            } else if (node.material.dispose) {
                                node.material.dispose();
                            }
                        }

                        // ÏÉàÎ°úÏö¥ material Ï†ÅÏö©
                        node.material = knightMaterial.clone();
                        
                        // Í∑∏Î¶ºÏûê ÏÑ§Ï†ï
                        node.castShadow = true;
                        node.receiveShadow = true;
                    }
                });

                this.scene.add(this.knight);
            },
            (xhr) => {
                console.log((xhr.loaded / xhr.total * 100) + '% loaded');
            },
            (error) => {
                console.error('An error happened while loading the knight model:', error);
                this.createDefaultKnight();
            }
        );
    }

    createDefaultKnight() {
        // Îçî Î≥µÏû°Ìïú ÎÇòÏù¥Ìä∏ Î™®Îç∏ ÏÉùÏÑ±
        const group = new THREE.Group();
        
        // ÎÇòÏù¥Ìä∏Ïùò Î™∏Ï≤¥
        const bodyGeometry = new THREE.CylinderGeometry(0.2, 0.3, 0.4, 8);
        const bodyMaterial = new THREE.MeshPhongMaterial({ 
            color: 0xC0C0C0, // Ïã§Î≤Ñ ÏÉâÏÉÅ
            specular: 0xFFFFFF, // Î∞òÏÇ¨Í¥ë ÏÉâÏÉÅ
            shininess: 100, // Î∞òÏÇ¨ÎèÑ Ï¶ùÍ∞Ä
            metalness: 0.9, // Í∏àÏÜçÏÑ±
            roughness: 0.1 // Í±∞Ïπ†Í∏∞ Í∞êÏÜå
        });
        const body = new THREE.Mesh(bodyGeometry, bodyMaterial);
        body.position.y = 0.3;
        group.add(body);

        // ÎÇòÏù¥Ìä∏Ïùò Î®∏Î¶¨
        const headGeometry = new THREE.SphereGeometry(0.2, 16, 16);
        const headMaterial = new THREE.MeshPhongMaterial({ 
            color: 0xC0C0C0, // Ïã§Î≤Ñ ÏÉâÏÉÅ
            specular: 0xFFFFFF, // Î∞òÏÇ¨Í¥ë ÏÉâÏÉÅ
            shininess: 100, // Î∞òÏÇ¨ÎèÑ Ï¶ùÍ∞Ä
            metalness: 0.9, // Í∏àÏÜçÏÑ±
            roughness: 0.1 // Í±∞Ïπ†Í∏∞ Í∞êÏÜå
        });
        const head = new THREE.Mesh(headGeometry, headMaterial);
        head.position.y = 0.6;
        group.add(head);

        // ÎÇòÏù¥Ìä∏Ïùò ÎßêÎ®∏Î¶¨
        const maneGeometry = new THREE.ConeGeometry(0.15, 0.3, 8);
        const maneMaterial = new THREE.MeshPhongMaterial({ 
            color: 0xC0C0C0, // Ïã§Î≤Ñ ÏÉâÏÉÅ
            specular: 0xFFFFFF, // Î∞òÏÇ¨Í¥ë ÏÉâÏÉÅ
            shininess: 100, // Î∞òÏÇ¨ÎèÑ Ï¶ùÍ∞Ä
            metalness: 0.9, // Í∏àÏÜçÏÑ±
            roughness: 0.1 // Í±∞Ïπ†Í∏∞ Í∞êÏÜå
        });
        const mane = new THREE.Mesh(maneGeometry, maneMaterial);
        mane.position.set(0.2, 0.75, 0);
        mane.rotation.z = -Math.PI / 4;
        group.add(mane);

        // ÎÇòÏù¥Ìä∏Ïùò Îã§Î¶¨
        const legGeometry = new THREE.CylinderGeometry(0.05, 0.05, 0.4, 8);
        const legMaterial = new THREE.MeshPhongMaterial({ 
            color: 0xC0C0C0, // Ïã§Î≤Ñ ÏÉâÏÉÅ
            specular: 0xFFFFFF, // Î∞òÏÇ¨Í¥ë ÏÉâÏÉÅ
            shininess: 100, // Î∞òÏÇ¨ÎèÑ Ï¶ùÍ∞Ä
            metalness: 0.9, // Í∏àÏÜçÏÑ±
            roughness: 0.1 // Í±∞Ïπ†Í∏∞ Í∞êÏÜå
        });
        
        const leftLeg = new THREE.Mesh(legGeometry, legMaterial);
        leftLeg.position.set(-0.15, 0, 0);
        group.add(leftLeg);

        const rightLeg = new THREE.Mesh(legGeometry, legMaterial);
        rightLeg.position.set(0.15, 0, 0);
        group.add(rightLeg);

        // Ï†ÑÏ≤¥ Í∑∏Î£π ÏÑ§Ï†ï
        group.scale.set(0.6, 0.9, 0.6);
        group.position.set(-3.5, 0.3, -3.5);
        group.visible = false;
        group.castShadow = true;

        this.knight = group;
        this.scene.add(this.knight);
    }

    setupMobileFriendlyUI() {
        // Start Journey Î≤ÑÌäº Ïä§ÌÉÄÏùº
        const startBtn = document.getElementById('start-btn');
        startBtn.style.padding = '12px 24px';
        startBtn.style.fontSize = '16px';
        startBtn.style.borderRadius = '8px';
        startBtn.style.border = 'none';
        startBtn.style.backgroundColor = '#4CAF50';
        startBtn.style.color = 'white';
        startBtn.style.cursor = 'pointer';
        startBtn.style.transition = 'all 0.3s ease';
        startBtn.style.boxShadow = '0 2px 4px rgba(0,0,0,0.2)';
        startBtn.style.margin = '10px';
        startBtn.style.minWidth = '120px';

        // ÏÉÅÌÉú ÌëúÏãú Ïä§ÌÉÄÏùº
        const status = document.getElementById('status');
        status.style.fontSize = '16px';
        status.style.padding = '10px';
        status.style.margin = '10px';
        status.style.textAlign = 'center';
        // status.style.backgroundColor = 'rgba(0, 0, 0, 0.7)';
        status.style.color = 'white';
        status.style.borderRadius = '5px';
        status.style.maxWidth = '90%';
        status.style.marginLeft = 'auto';
        status.style.marginRight = 'auto';
        // status.style.position = 'absolute';
        status.style.bottom = '20px';
        status.style.left = '50%';
        status.style.transform = 'translateX(-50%)';
        status.style.zIndex = '1000';
        status.style.wordWrap = 'break-word';
        status.style.whiteSpace = 'normal';
        status.style.lineHeight = '1.4';

        // Ïù¥Îèô ÌöüÏàò ÌëúÏãú Ïä§ÌÉÄÏùº
        const movesCount = document.getElementById('moves-count');
        movesCount.style.fontSize = '16px';
        movesCount.style.padding = '8px 16px';
        // movesCount.style.backgroundColor = 'rgba(0, 0, 0, 0.7)';
        movesCount.style.color = 'white';
        movesCount.style.borderRadius = '5px';
        // movesCount.style.position = 'absolute';
        movesCount.style.top = '10px';
        movesCount.style.right = '10px';
        movesCount.style.zIndex = '1000';
        movesCount.style.whiteSpace = 'nowrap';
        movesCount.style.maxWidth = 'calc(100% - 20px)';
        movesCount.style.overflow = 'hidden';
        movesCount.style.textOverflow = 'ellipsis';

        // Î™®Î∞îÏùº ÌôòÍ≤Ω Í∞êÏßÄ
        const isMobile = /iPhone|iPad|iPod|Android/i.test(navigator.userAgent);
        if (isMobile) {
            // Î™®Î∞îÏùºÏóêÏÑú ÏÉÅÌÉú ÌëúÏãú Ïä§ÌÉÄÏùº Ï°∞Ï†ï
            status.style.fontSize = '14px';
            status.style.padding = '8px';
            status.style.margin = '5px';
            status.style.maxWidth = '95%';
            status.style.bottom = '10px';

            // Î™®Î∞îÏùºÏóêÏÑú Ïù¥Îèô ÌöüÏàò ÌëúÏãú Ïä§ÌÉÄÏùº Ï°∞Ï†ï
            movesCount.style.fontSize = '14px';
            movesCount.style.padding = '6px 12px';
            movesCount.style.top = '5px';
            movesCount.style.right = '5px';
        }
    }

    setupEventListeners() {
        const startBtn = document.getElementById('start-btn');
        startBtn.addEventListener('click', () => {
            this.reset();
            this.startGame();
        });

        // Î™®Î∞îÏùº ÌôòÍ≤ΩÏóêÏÑúÏùò ÌÑ∞Ïπò Ïù¥Î≤§Ìä∏ Ï≤òÎ¶¨
        const isMobile = /iPhone|iPad|iPod|Android/i.test(navigator.userAgent);
        if (isMobile) {
            this.renderer.domElement.addEventListener('touchstart', (event) => {
                event.preventDefault();
                const touch = event.touches[0];
                const mouseEvent = new MouseEvent('click', {
                    clientX: touch.clientX,
                    clientY: touch.clientY
                });
                this.onMouseClick(mouseEvent);
            });
        } else {
            this.renderer.domElement.addEventListener('click', (event) => this.onMouseClick(event));
        }

        window.addEventListener('resize', () => this.onWindowResize());
    }

    startGame() {
        if (!this.gameStarted) {
            this.selectingStartPosition = true;
            document.getElementById('status').textContent = 'Select starting position';
        }
    }

    reset() {
        // Í≤åÏûÑ Ïò§Î≤Ñ Ïï†ÎãàÎ©îÏù¥ÏÖò Ï§ëÎã®
        if (this.gameOverAnimationTimeline) {
            this.gameOverAnimationTimeline.kill();
            this.gameOverAnimationTimeline = null;
        }

        // Î™®Îì† GSAP Ïï†ÎãàÎ©îÏù¥ÏÖò Ï§ëÎã®
        gsap.killTweensOf(this.squares);
        gsap.killTweensOf(this.knight);
        gsap.killTweensOf(this.camera.position);
        
        this.moves = 0;
        this.visited.clear();
        this.possibleMoves = [];
        this.gameStarted = false;
        this.selectingStartPosition = true;
        
        // Î∞©Î¨∏Ìïú Ïπ∏ ÌëúÏãú Ï†úÍ±∞
        this.visitedSquares.forEach(square => {
            this.scene.remove(square);
        });
        this.visitedSquares = [];
        
        if (this.knight) {
            this.knight.visible = false;
        }
        this.currentPosition = null;

        // Ï≤¥Ïä§Ìåê Î≥µÍµ¨
        this.squares.forEach(square => {
            // ÏúÑÏπò Î≥µÍµ¨
            gsap.to(square.position, {
                y: 0.1,
                duration: 0.5,
                ease: "power2.out"
            });
            // ÌöåÏ†Ñ Î≥µÍµ¨
            gsap.to(square.rotation, {
                x: 0,
                z: 0,
                duration: 0.5,
                ease: "power2.out"
            });
        });

        // Î∞∞Í≤Ω Ï≤¥Ïä§Ìåê Î≥µÍµ¨
        const board = this.scene.children.find(child => child.geometry && child.geometry.type === 'BoxGeometry');
        if (board) {
            gsap.to(board.position, {
                y: 0,
                duration: 0.5,
                ease: "power2.out"
            });
            gsap.to(board.rotation, {
                x: 0,
                z: 0,
                duration: 0.5,
                ease: "power2.out"
            });
        }

        this.updatePossibleMoveIndicators();
        document.getElementById('moves-count').textContent = `0 / ${this.boardSize * this.boardSize}`;
        document.getElementById('status').textContent = 'Select starting position';

        // Ïπ¥Î©îÎùº ÏúÑÏπò Ï¥àÍ∏∞Ìôî
        this.initializeCameraPosition();

        // Ìè≠Ï£Ω Ìö®Í≥º Ï¥àÍ∏∞Ìôî
        if (this.confetti) {
            this.confetti.clearCanvas();
        }

        // Í≤åÏûÑ Ïò§Î≤Ñ Ïò§Î≤ÑÎ†àÏù¥ Ï†úÍ±∞
        if (this.gameOverOverlay) {
            const container = document.getElementById('board-container');
            container.removeChild(this.gameOverOverlay);
            this.gameOverOverlay = null;
        }

        // Í∞ÄÎä•Ìïú Ïù¥Îèô ÌëúÏãúÍ∏∞ Ï†úÍ±∞
        this.possibleMoveIndicators.forEach(indicator => {
            this.scene.remove(indicator);
        });
        this.possibleMoveIndicators = [];
    }

    onMouseClick(event) {
        if (!this.selectingStartPosition && !this.gameStarted) return;
        if (this.isMoving) return;

        // ÎßàÏö∞Ïä§ ÏúÑÏπòÎ•º Ï†ïÍ∑úÌôîÎêú Ïû•Ïπò Ï¢åÌëúÎ°ú Î≥ÄÌôò
        const rect = this.renderer.domElement.getBoundingClientRect();
        this.mouse.x = ((event.clientX - rect.left) / rect.width) * 2 - 1;
        this.mouse.y = -((event.clientY - rect.top) / rect.height) * 2 + 1;

        // Î†àÏù¥Ï∫êÏä§ÌåÖ
        this.raycaster.setFromCamera(this.mouse, this.camera);
        
        if (this.selectingStartPosition) {
            // ÏãúÏûë ÏúÑÏπò ÏÑ†ÌÉù Ïãú Ï≤¥Ïä§ÌåêÎßå Í≤ÄÏÇ¨
            const intersects = this.raycaster.intersectObjects(this.squares);
            if (intersects.length > 0) {
                const square = intersects[0].object;
                const row = square.userData.row;
                const col = square.userData.col;
                const halfSize = this.boardSize / 2;
                const position = { x: row, y: col };
                this.setStartPosition(position);
            }
        } else if (this.gameStarted) {
            // Ïù¥Îèô Ïãú Í∞ÄÎä•Ìïú Ïù¥Îèô ÌëúÏãúÍ∏∞ÏôÄ Ï≤¥Ïä§Ìåê Î™®Îëê Í≤ÄÏÇ¨
            const allIntersects = this.raycaster.intersectObjects([
                ...this.possibleMoveIndicators,
                ...this.squares
            ]);

            if (allIntersects.length > 0) {
                const clickedObject = allIntersects[0].object;
                const halfSize = this.boardSize / 2;
                
                // Í∞ÄÎä•Ìïú Ïù¥Îèô ÌëúÏãúÍ∏∞Î•º ÌÅ¥Î¶≠Ìïú Í≤ΩÏö∞
                if (this.possibleMoveIndicators.includes(clickedObject)) {
                    const indicatorIndex = this.possibleMoveIndicators.indexOf(clickedObject);
                    const move = this.possibleMoves[indicatorIndex];
                    if (move) {
                        // ÏÑ†ÌÉùÎêòÏßÄ ÏïäÏùÄ ÏõêÌòïÎì§ Ïï†ÎãàÎ©îÏù¥ÏÖòÏúºÎ°ú Ï∂ïÏÜå
                        this.possibleMoveIndicators.forEach((indicator, index) => {
                            if (index !== indicatorIndex) {
                                gsap.to(indicator.scale, {
                                    x: 0,
                                    y: 0,
                                    z: 0,
                                    duration: 0.3,
                                    ease: "power2.in",
                                    onComplete: () => {
                                        this.scene.remove(indicator);
                                    }
                                });
                            }
                        });
                        this.makeMove(move);
                    }
                }
                // Ï≤¥Ïä§ÌåêÏùÑ ÌÅ¥Î¶≠Ìïú Í≤ΩÏö∞
                else if (this.squares.includes(clickedObject)) {
                    const clickedRow = clickedObject.userData.row;
                    const clickedCol = clickedObject.userData.col;
                    const clickedPosition = { x: clickedCol, y: clickedRow };
                    
                    // ÌÅ¥Î¶≠Ìïú ÏúÑÏπòÍ∞Ä Í∞ÄÎä•Ìïú Ïù¥Îèô ÏúÑÏπòÏù∏ÏßÄ ÌôïÏù∏
                    const isValidMove = this.possibleMoves.some(move => 
                        move.x === clickedPosition.x && move.y === clickedPosition.y
                    );
                    
                    if (isValidMove) {
                        // ÏÑ†ÌÉùÎêòÏßÄ ÏïäÏùÄ ÏõêÌòïÎì§ Ïï†ÎãàÎ©îÏù¥ÏÖòÏúºÎ°ú Ï∂ïÏÜå
                        this.possibleMoveIndicators.forEach((indicator, index) => {
                            const move = this.possibleMoves[index];
                            if (move.x !== clickedPosition.x || move.y !== clickedPosition.y) {
                                gsap.to(indicator.scale, {
                                    x: 0,
                                    y: 0,
                                    z: 0,
                                    duration: 0.3,
                                    ease: "power2.in",
                                    onComplete: () => {
                                        this.scene.remove(indicator);
                                    }
                                });
                            }
                        });
                        this.makeMove(clickedPosition);
                    }
                }
            }
        }
    }

    setStartPosition(position) {
        if (this.knight) {
            this.knight.visible = true;
            const halfSize = this.boardSize / 2;
            this.knight.position.set(-halfSize + 0.5 + position.x, 0.3, -halfSize + 0.5 + position.y); // ÎÜíÏù¥ Ï°∞Ï†ï
        }
        this.currentPosition = position;
        this.visited.add(`${position.x},${position.y}`);
        this.markSquareAsVisited(position.x, position.y);
        this.selectingStartPosition = false;
        this.gameStarted = true;
        this.moves = 1;
        document.getElementById('moves-count').textContent = `${this.moves} / ${this.boardSize * this.boardSize}`;
        this.updatePossibleMoves();
        this.updatePossibleMoveIndicators();
        document.getElementById('status').textContent = 'Select a move';
    }

    createVisitedIndicator() {
        const geometry = new THREE.CylinderGeometry(0.4, 0.4, 0.05, 32);
        const material = new THREE.MeshPhongMaterial({
            color: 0x81D4FA,
            transparent: true,
            opacity: 0.5,
            side: THREE.DoubleSide,
            emissive: 0x4FC3F7,
            emissiveIntensity: 0.2
        });
        const indicator = new THREE.Mesh(geometry, material);
        indicator.rotation.x = 0; // Ï≤¥Ïä§ÌåêÍ≥º ÌèâÌñâÌïòÎèÑÎ°ù ÌöåÏ†Ñ
        return indicator;
    }

    markSquareAsVisited(x, y) {
        const visitedIndicator = this.createVisitedIndicator();
        const halfSize = this.boardSize / 2;
        visitedIndicator.position.set(-halfSize + 0.5 + x, 0.2, -halfSize + 0.5 + y);
        this.visitedSquares.push(visitedIndicator);
        this.scene.add(visitedIndicator);

        gsap.from(visitedIndicator.scale, {
            x: 0,
            y: 0,
            z: 0,
            duration: 0.5,
            ease: "back.out(1.7)"
        });
    }

    makeMove(move) {
        this.isMoving = true;
        const halfSize = this.boardSize / 2;
        const targetX = -halfSize + 0.5 + move.x;
        const targetZ = -halfSize + 0.5 + move.y;

        // Start Journey Î≤ÑÌäº ÎπÑÌôúÏÑ±Ìôî
        const startBtn = document.getElementById('start-btn');
        startBtn.disabled = true;
        startBtn.style.opacity = '0.5';
        startBtn.style.cursor = 'not-allowed';

        // GSAP ÌÉÄÏûÑÎùºÏù∏ ÏÉùÏÑ±
        const tl = gsap.timeline({
            onComplete: () => {
                this.currentPosition = move;
                this.visited.add(`${move.x},${move.y}`);
                this.markSquareAsVisited(move.x, move.y);
                this.moves++;
                document.getElementById('moves-count').textContent = `${this.moves} / ${this.boardSize * this.boardSize}`;
                this.updatePossibleMoves();
                this.updatePossibleMoveIndicators();
                this.checkGameStatus();
                this.isMoving = false;

                // Start Journey Î≤ÑÌäº Îã§Ïãú ÌôúÏÑ±Ìôî
                startBtn.disabled = false;
                startBtn.style.opacity = '1';
                startBtn.style.cursor = 'pointer';
            }
        });

        // 1. ÏúÑÎ°ú Ïò¨ÎùºÍ∞ÄÎäî Ïï†ÎãàÎ©îÏù¥ÏÖò
        tl.to(this.knight.position, {
            y: 1.05, // ÎÜíÏù¥ Ï°∞Ï†ï
            duration: 0.3,
            ease: "power2.out"
        });

        // 2. Î™©Ìëú ÏßÄÏ†êÏúºÎ°ú Ïù¥ÎèôÌïòÎäî Ïï†ÎãàÎ©îÏù¥ÏÖò
        tl.to(this.knight.position, {
            x: targetX,
            z: targetZ,
            duration: 0.4,
            ease: "power2.inOut"
        });

        // 3. ÏïÑÎûòÎ°ú ÎÇ¥Î†§Í∞ÄÎäî Ïï†ÎãàÎ©îÏù¥ÏÖò
        tl.to(this.knight.position, {
            y: 0.3, // ÎÜíÏù¥ Ï°∞Ï†ï
            duration: 0.3,
            ease: "power2.in"
        });
    }

    updatePossibleMoves() {
        this.possibleMoves = [];
        const moves = [
            { x: 2, y: 1 }, { x: 2, y: -1 },
            { x: -2, y: 1 }, { x: -2, y: -1 },
            { x: 1, y: 2 }, { x: 1, y: -2 },
            { x: -1, y: 2 }, { x: -1, y: -2 }
        ];

        for (const move of moves) {
            const newX = this.currentPosition.x + move.x;
            const newY = this.currentPosition.y + move.y;
            const key = `${newX},${newY}`;

            if (newX >= 0 && newX < this.boardSize && 
                newY >= 0 && newY < this.boardSize && 
                !this.visited.has(key)) {
                this.possibleMoves.push({ x: newX, y: newY });
            }
        }
    }

    checkGameStatus() {
        if (this.possibleMoves.length === 0) {
            if (this.visited.size === this.boardSize * this.boardSize) {
                const status = document.getElementById('status');
                status.textContent = 'üéâ Congratulations! You completed the journey! üéâ';
                // ÏÉÅÌÉú Î©îÏãúÏßÄÍ∞Ä Í∏∏ Í≤ΩÏö∞ Ï§ÑÏûÑ
                if (window.innerWidth < 768) {
                    status.textContent = 'üéâ Journey Complete! üéâ';
                }
                this.victoryAnimation();
            } else {
                const status = document.getElementById('status');
                status.textContent = `Game Over! Visited ${this.visited.size}/${this.boardSize * this.boardSize} squares.`;
                // ÏÉÅÌÉú Î©îÏãúÏßÄÍ∞Ä Í∏∏ Í≤ΩÏö∞ Ï§ÑÏûÑ
                if (window.innerWidth < 768) {
                    status.textContent = `Game Over! ${this.visited.size}/${this.boardSize * this.boardSize}`;
                }
                this.gameOverAnimation();
            }
            this.gameStarted = false;
            document.getElementById('start-btn').style.display = 'block';
        } else {
            document.getElementById('status').textContent = 'Select a move';
        }
    }

    victoryAnimation() {
        console.log('Victory animation started');
        
        // Start Journey Î≤ÑÌäº ÌôúÏÑ±Ìôî
        const startBtn = document.getElementById('start-btn');
        startBtn.disabled = false;
        startBtn.style.opacity = '1';
        startBtn.style.cursor = 'pointer';
        startBtn.style.display = 'block';
        
        // 1. Ìè≠Ï£Ω Ìö®Í≥º
        if (this.confetti) {
            console.log('Triggering confetti effect');
            this.confetti({
                particleCount: 100,
                spread: 70,
                origin: { y: 0.6 }
            });
        } else {
            console.error('Confetti instance not initialized');
        }

        // 2. Ïπ¥Î©îÎùº ÌöåÏ†Ñ Ïï†ÎãàÎ©îÏù¥ÏÖò
        gsap.to(this.camera.position, {
            x: 5,
            y: 5,
            z: 5,
            duration: 2,
            ease: "power2.inOut",
            onComplete: () => {
                gsap.to(this.camera.position, {
                    x: -5,
                    y: 5,
                    z: 5,
                    duration: 2,
                    ease: "power2.inOut",
                    onComplete: () => {
                        gsap.to(this.camera.position, {
                            x: 0,
                            y: 5,
                            z: 5,
                            duration: 2,
                            ease: "power2.inOut"
                        });
                    }
                });
            }
        });

        // 3. ÎÇòÏù¥Ìä∏ ÏäπÎ¶¨ Ïï†ÎãàÎ©îÏù¥ÏÖò
        if (this.knight) {
            gsap.to(this.knight.position, {
                y: 1,
                duration: 0.5,
                ease: "bounce.out"
            });
        }
    }

    gameOverAnimation() {
        // Start Journey Î≤ÑÌäº ÎπÑÌôúÏÑ±Ìôî
        const startBtn = document.getElementById('start-btn');
        startBtn.disabled = true;
        startBtn.style.opacity = '0.5';
        startBtn.style.cursor = 'not-allowed';

        // Î™®Îì† Ïï†ÎãàÎ©îÏù¥ÏÖòÏùò Ï¥ù ÏßÄÏÜç ÏãúÍ∞Ñ Í≥ÑÏÇ∞
        const totalAnimationDuration = 5000; // 5Ï¥à

        // GSAP ÌÉÄÏûÑÎùºÏù∏ ÏÉùÏÑ±
        this.gameOverAnimationTimeline = gsap.timeline();

        // 1. Visited indicators ÏÉâÏÉÅ Î≥ÄÍ≤Ω
        this.visitedSquares.forEach(square => {
            this.gameOverAnimationTimeline.to(square.material, {
                color: 0xFF0000,
                opacity: 0.3,
                duration: 1,
                ease: "power2.inOut"
            }, 0);
        });

        // 2. Ï≤¥Ïä§Ìåê Î¨¥ÎÑàÏßê Ïï†ÎãàÎ©îÏù¥ÏÖò
        this.squares.forEach((square, index) => {
            const delay = Math.random() * 2;
            const rotationX = Math.random() * Math.PI * 2;
            const rotationZ = Math.random() * Math.PI * 2;
            
            this.gameOverAnimationTimeline.to(square.position, {
                y: -5,
                duration: 2,
                delay: delay,
                ease: "power2.in"
            }, 0);

            this.gameOverAnimationTimeline.to(square.rotation, {
                x: rotationX,
                z: rotationZ,
                duration: 2,
                delay: delay,
                ease: "power2.in"
            }, 0);
        });

        // 3. ÎÇòÏù¥Ìä∏ Ï∂îÎùΩ Ïï†ÎãàÎ©îÏù¥ÏÖò
        if (this.knight) {
            this.gameOverAnimationTimeline.to(this.knight.position, {
                y: -5,
                duration: 2,
                delay: 1,
                ease: "power2.in",
                onComplete: () => {
                    this.knight.visible = false;
                }
            }, 0);
        }

        // 4. Î∞∞Í≤Ω Ï≤¥Ïä§Ìåê Î¨¥ÎÑàÏßê
        const board = this.scene.children.find(child => child.geometry && child.geometry.type === 'BoxGeometry');
        if (board) {
            this.gameOverAnimationTimeline.to(board.position, {
                y: -5,
                duration: 2.5,
                delay: 0.5,
                ease: "power2.in"
            }, 0);

            this.gameOverAnimationTimeline.to(board.rotation, {
                x: Math.PI / 4,
                z: Math.PI / 4,
                duration: 2.5,
                delay: 0.5,
                ease: "power2.in"
            }, 0);
        }

        // 5. ÌôîÎ©¥ ÌéòÏù¥Îìú ÏïÑÏõÉ Ìö®Í≥º
        const container = document.getElementById('board-container');
        if (this.gameOverOverlay) {
            container.removeChild(this.gameOverOverlay);
        }
        
        this.gameOverOverlay = document.createElement('div');
        this.gameOverOverlay.style.position = 'absolute';
        this.gameOverOverlay.style.top = '0';
        this.gameOverOverlay.style.left = '0';
        this.gameOverOverlay.style.width = '100%';
        this.gameOverOverlay.style.height = '100%';
        this.gameOverOverlay.style.backgroundColor = this.isDarkTheme ? '#1a1a1a' : '#f0f0f0';
        this.gameOverOverlay.style.opacity = '0';
        this.gameOverOverlay.style.transition = 'opacity 2s ease-in-out';
        this.gameOverOverlay.style.zIndex = '1000';
        container.appendChild(this.gameOverOverlay);

        // Ïï†ÎãàÎ©îÏù¥ÏÖò ÏãúÌÄÄÏä§ ÏãúÏûë
        setTimeout(() => {
            // ÌéòÏù¥Îìú ÏïÑÏõÉ ÏãúÏûë
            this.gameOverOverlay.style.opacity = '1';
            
            // Î™®Îì† Ïï†ÎãàÎ©îÏù¥ÏÖòÏù¥ ÏôÑÎ£åÎêú ÌõÑ Start Journey Î≤ÑÌäº ÌôúÏÑ±Ìôî
            setTimeout(() => {
                startBtn.disabled = false;
                startBtn.style.opacity = '1';
                startBtn.style.cursor = 'pointer';
                startBtn.style.display = 'block';
            }, totalAnimationDuration);
        }, 1000);
    }

    onWindowResize() {
        const container = document.getElementById('board-container');
        const width = container.clientWidth;
        const height = container.clientHeight;
        
        // Ïπ¥Î©îÎùº ÎπÑÏú® ÏóÖÎç∞Ïù¥Ìä∏
        this.camera.aspect = width / height;
        this.camera.updateProjectionMatrix();
        this.renderer.setSize(width, height);

        // Ïπ¥Î©îÎùº ÏúÑÏπò Ï¥àÍ∏∞Ìôî
        this.initializeCameraPosition();

        // ÏÉÅÌÉú Î©îÏãúÏßÄ ÏóÖÎç∞Ïù¥Ìä∏
        const status = document.getElementById('status');
        if (this.possibleMoves.length === 0) {
            if (this.visited.size === this.boardSize * this.boardSize) {
                status.textContent = window.innerWidth < 768 ? 
                    'üéâ Journey Complete! üéâ' : 
                    'üéâ Congratulations! You completed the journey! üéâ';
            } else {
                status.textContent = window.innerWidth < 768 ? 
                    `Game Over! ${this.visited.size}/${this.boardSize * this.boardSize}` : 
                    `Game Over! Visited ${this.visited.size}/${this.boardSize * this.boardSize} squares.`;
            }
        }
    }

    animate() {
        requestAnimationFrame(() => this.animate());
        this.controls.update();
        this.renderer.render(this.scene, this.camera);
    }

    // Ïπ¥Î©îÎùº ÏúÑÏπò Ï¥àÍ∏∞Ìôî Í≥µÌÜµ Ìï®Ïàò
    initializeCameraPosition() {
        const isMobile = /iPhone|iPad|iPod|Android/i.test(navigator.userAgent);
        const cameraDistance = this.boardSize * (isMobile ? 1.67 : 1.33);
        const cameraHeight = 3 * cameraDistance / 5;
        const cameraDepth = 2 * cameraDistance / 5;
        
        this.camera.position.set(0, cameraHeight, cameraDepth);
        this.camera.lookAt(0, 0, 0);
        
        this.controls.minDistance = this.boardSize * (isMobile ? 1.11 : 0.56);
        this.controls.maxDistance = this.boardSize * (isMobile ? 2.78 : 1.67);
        this.controls.target.set(0, 0, 0);
        this.controls.update();
    }
}

// Í≤åÏûÑ Ïù∏Ïä§ÌÑ¥Ïä§ ÏÉùÏÑ±
const game = new KnightJourney3D(); 